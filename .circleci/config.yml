version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - restore_cache:
          name: Restore Cached Server Dependencies
          keys:
            - server-{{ checksum "server/ringofworlds.cabal" }}-{{ checksum "server/stack.yaml" }}
      - run:
          name: Server
          command: cd server &&
                   sudo curl -sSL https://get.haskellstack.org/ | sh &&
                   stack docker pull &&
                   stack setup &&
                   stack install &&
                   stack test &&
                   stack image container
      - run:
          name: Setup Client
          command: cd client &&
                   npm install -g gulp@4.0.0 gulp-cli@2.0.1 elm@0.18.0 elm-analyse@0.15.0 &&
                   npm install &&
                   elm-package install --yes &&
                   gulp build &&
                   elm-analyse
      - run:
          name: Setup Docker machine
          command: base=https://github.com/docker/machine/releases/download/v0.14.0 &&
                   curl -L $base/docker-machine-$(uname -s)-$(uname -m) >/tmp/docker-machine &&
                   sudo install /tmp/docker-machine /usr/local/bin/docker-machine
      - run:
          name: Setup Python
          command: sudo apt-get update &&
                   sudo apt-get install python3-pip &&
                   sudo /usr/bin/python3 -m pip install requests==2.18.4
      - run:
          name: Deploy
          command: if [ $CIRCLE_BRANCH == 'master' ]; then ./scripts/decryptSecrets && ./scripts/deploy; fi
      - save_cache:
          name: Cache Dependencies
          key: server-{{ checksum "server/ringofworlds.cabal" }}-{{ checksum "server/stack.yaml" }}
          paths:
            - "server/.stack"
            - "server/.stack-work"
