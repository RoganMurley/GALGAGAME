version: 2
jobs:
  build:
    machine:
      image: circleci/classic:edge
    steps:
      - checkout
      - restore_cache:
          name: Restore Cached NPM Dependencies
          keys:
            - npm-{{ checksum "client/package.json" }}-1
      - restore_cache:
          name: Restore Cached Elm Dependencies
          keys:
            - elm-0.19.1-{{ checksum "client/elm.json" }}-1
      - run:
          name: Setup npm
          command: curl -sL https://deb.nodesource.com/setup_12.x | sudo -E bash - &&
                   sudo apt-get update &&
                   sudo apt-get install nodejs &&
                   mkdir ~/.npm-global &&
                   npm config set prefix '~/.npm-global' &&
                   echo 'PATH=~/.npm-global/bin:$PATH' >> $BASH_ENV
      - run:
          name: Setup Client
          command: cd client &&
                   npm install -g gulp@4.0.0 gulp-cli@2.0.1 elm@0.19.1-5 elm-analyse@0.16.5 &&
                   npm install &&
                   gulp build
                   # Temp disable elm-analyse due to circleci issues with
                   # https://github.com/stil4m/elm-analyse/issues/218
                   # gulp build &&
                   # elm-analyse
      - run:
          name: Setup Docker machine
          command: base=https://github.com/docker/machine/releases/download/v0.16.2 &&
                   curl -L $base/docker-machine-$(uname -s)-$(uname -m) >/tmp/docker-machine &&
                   sudo install /tmp/docker-machine /usr/local/bin/docker-machine
      - run:
          name: Setup Python
          command: sudo apt-get update &&
                   sudo apt-get install python3-pip &&
                   sudo /usr/bin/python3 -m pip install requests==2.18.4
      - run:
          name: Get websocat
          command: wget https://github.com/vi/websocat/releases/download/v1.9.0/websocat_linux64; chmod +x websocat_linux64;
      - run:
          name: Notify users
          command: if [ $CIRCLE_BRANCH == 'master' ]; then ./scripts/systemMessage "ðŸ”” Server update scheduled in ~30 minutes ðŸ””" || true; fi
      - run:
          name: Deploy
          command: if [ $CIRCLE_BRANCH == 'master' ]; then ./scripts/decryptSecrets && ./scripts/deploy; fi
      - save_cache:
          name: Cache NPM Dependencies
          key: npm-{{ checksum "client/package.json" }}-1
          paths:
            - "./client/node-modules"
      - save_cache:
          name: Cache Elm Dependencies
          key: elm-0.19.1-{{ checksum "client/elm.json" }}-1
          paths:
            - "~/.elm"
            - "./client/elm-stuff"
